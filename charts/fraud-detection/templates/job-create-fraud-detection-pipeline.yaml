apiVersion: v1
kind: ServiceAccount
metadata:
  name: pipeline-bootstrap
  namespace: fraud-detection
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: port-forwarder
  namespace: fraud-detection
rules:
  - apiGroups: [""]
    resources: ["services", "endpoints"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/portforward"]
    verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pipeline-bootstrap-portforward
  namespace: fraud-detection
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: port-forwarder
subjects:
  - kind: ServiceAccount
    name: pipeline-bootstrap
    namespace: fraud-detection
---
apiVersion: batch/v1
kind: Job
metadata:
  name: create-fraud-detection-pipeline
  namespace: fraud-detection
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: null
  template:
    metadata:
      name: create-fraud-detection-pipeline
    spec:
      serviceAccountName: pipeline-bootstrap
      restartPolicy: Never
      containers:
        - name: bootstrap
          image: image-registry.openshift-image-registry.svc:5000/openshift/tools:latest
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - -ec
            - |
              set -o pipefail

              # ------------------------------------------------------------------
              # 0) Start port-forward in background
              # ------------------------------------------------------------------
              echo "Starting port-forward svc/ds-pipeline-dspa 8443→8888 …"
              oc -n fraud-detection port-forward svc/ds-pipeline-dspa 8443:8888 --address 127.0.0.1 &
              PF_PID=$!
              trap "kill ${PF_PID}" EXIT

              # ------------------------------------------------------------------
              # 1) Wait for the local tunnel to be ready
              # ------------------------------------------------------------------
              API="https://127.0.0.1:8443"
              HEALTH="${API}/apis/v2beta1/healthz"
              PIPELINES="${API}/apis/v2beta1/pipelines"
              RUNS="${API}/apis/v2beta1/runs"

              echo "Waiting for ${HEALTH} …"
              for i in {1..60}; do
                if curl -ksf "${HEALTH}" >/dev/null ; then
                  echo "✓ Pipeline API is ready via port-forward."
                  break
                fi
                sleep 5
              done

              # ------------------------------------------------------------------
              # 2) Create the pipeline
              # ------------------------------------------------------------------
              # Write JSON payload to a safe location
              cat > /tmp/payload.json <<'EOF'
              {
                "pipeline": {
                  "display_name": "fraud-detection",
                  "description": ""
                },
                "pipeline_version": {
                  "display_name": "fraud-detection",
                  "description": "",
                  "package_url": {
                    "pipeline_url": "https://raw.githubusercontent.com/rh-aiservices-bu/fraud-detection/main/7_get_data_train_upload.yaml"
                  }
                }
              }
              EOF

              # Post it and extract pipeline_id
              PIPELINE_ID=$(curl -ks -H 'Content-Type: application/json' \
                -X POST --data @/tmp/payload.json \
                "${PIPELINES}/create" \
                | python3 -c 'import sys, json; print(json.load(sys.stdin).get("pipeline_id", ""))')

              echo "pipeline_id=${PIPELINE_ID}"

              if [[ -z "${PIPELINE_ID}" ]]; then
                echo "❌ Failed to extract pipeline_id. Exiting."
                exit 1
              fi

              # ------------------------------------------------------------------
              # 2) Run the pipeline
              # ------------------------------------------------------------------
              echo "🚀  Triggering run …"
              curl -ks -H 'Content-Type: application/json' \
                   -X POST --data @- \
                   "${RUNS}" <<JSON
              {
                "display_name": "job-run",
                "description": "",
                "pipeline_version_reference": {
                  "pipeline_id": "${PIPELINE_ID}"
                },
                "runtime_config": {
                  "parameters": {}
                },
                "service_account": ""
              }
              JSON
