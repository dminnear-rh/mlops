apiVersion: batch/v1
kind: Job
metadata:
  name: create-fraud-detection-pipeline
  namespace: fraud-detection
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: null
  template:
    metadata:
      name: create-fraud-detection-pipeline
    spec:
      restartPolicy: Never
      automountServiceAccountToken: false
      containers:
        - name: bootstrap
          image: image-registry.openshift-image-registry.svc:5000/openshift/tools:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: NO_PROXY
              value: ".svc,.cluster.local"
          command:
            - /bin/bash
            - -ec
            - |
              API="https://ds-pipeline-dspa.fraud-detection.svc.cluster.local:8888"
              HEALTH="${API}/apis/v2beta1/healthz"
              CREATE="${API}/apis/v2beta1/pipelines/create"

              echo "Waiting for Pipeline API …"
              for i in {1..30}; do
                if curl --noproxy '*' -ksf "${HEALTH}" >/dev/null ; then
                  echo "✓ Ready"; break
                fi
                sleep 5
              done

              echo "Posting pipeline definition"
              curl --noproxy '*' -ks \
                   -H 'Content-Type: application/json' \
                   -X POST --data @- \
                   "${CREATE}" <<'JSON'
              {
                "pipeline": {
                  "display_name": "fraud-detection",
                  "description": ""
                },
                "pipeline_version": {
                  "display_name": "fraud-detection",
                  "description": "",
                  "package_url": {
                    "pipeline_url": "https://raw.githubusercontent.com/rh-aiservices-bu/fraud-detection/main/7_get_data_train_upload.yaml"
                  }
                }
              }
              JSON
              echo "✅ Done."
